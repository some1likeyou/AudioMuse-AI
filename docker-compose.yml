services:
  # --- 1. 数据库 ---
  db:
    image: postgres:15-alpine
    container_name: audiomuse-db
    restart: always
    environment:
      POSTGRES_USER: audiomuse
      POSTGRES_PASSWORD: audiomuse_password
      POSTGRES_DB: audiomuse
    volumes:
      # 请确认此路径是你极空间的真实硬盘路径
      - /tmp/zfsv3/nvme12/18140118870/data/docker/audiomuse-ai/postgres_data:/var/lib/postgresql/data
    networks:
      - audiomuse-net

  # --- 2. 缓存 ---
  redis:
    image: redis:alpine
    container_name: audiomuse-redis
    hostname: redis
    restart: always
    networks:
      - audiomuse-net

  # --- 3. AudioMuse Web (大脑) ---
  audiomuse-web:
    # 使用你自己的 GitHub 镜像
    image: ghcr.io/some1likeyou/audiomuse-ai:latest
    container_name: audiomuse-web
    restart: unless-stopped
    ports:
      - "8000:8000"
    environment:
      - TZ=Asia/Shanghai
      - SERVICE_TYPE=web
      # 强制使用中文界面
      - BABEL_DEFAULT_LOCALE=zh
      
      # --- 连接已有的 Navidrome ---
      - MEDIASERVER_TYPE=navidrome
      # 连接配置
      - NAVIDROME_URL=http://192.168.0.130:4533
      - NAVIDROME_USER=root
      - NAVIDROME_PASSWORD=tde7wz79
      
      # DeepSeek AI 配置
      - AI_MODEL_PROVIDER=openai
      - OPENAI_API_KEY=sk-2a2ad9195c7b4c6fa1d73a2a52624826
      - OPENAI_BASE_URL=https://api.deepseek.com
      - OPENAI_MODEL=deepseek-chat
      
      # 数据库连接
      - POSTGRES_USER=audiomuse
      - POSTGRES_PASSWORD=audiomuse_password
      - POSTGRES_DB=audiomuse
      - POSTGRES_HOST=db
      - REDIS_URL=redis://redis:6379/0
    depends_on:
      - db
      - redis
    networks:
      - audiomuse-net

  # --- 4. AudioMuse Worker (苦力) ---
  audiomuse-worker:
    # 使用你自己的 GitHub 镜像
    image: ghcr.io/some1likeyou/audiomuse-ai:latest
    container_name: audiomuse-worker
    restart: unless-stopped
    
    # 【必须保留】N97 核显直通，辅助 DSD 解码
    devices:
      - /dev/dri:/dev/dri
      
    environment:
      - TZ=Asia/Shanghai
      - SERVICE_TYPE=worker
      
      # 【必须保留】针对 N97 + DSD 的稳定性优化
      - CELERYD_CONCURRENCY=2
      - DEVICE=cpu
      
      # DeepSeek AI 配置
      - AI_MODEL_PROVIDER=openai
      - OPENAI_API_KEY=sk-2a2ad9195c7b4c6fa1d73a2a52624826
      - OPENAI_BASE_URL=https://api.deepseek.com
      - OPENAI_MODEL=deepseek-chat
      
      # 连接 Navidrome
      - MEDIASERVER_TYPE=navidrome
      - NAVIDROME_URL=http://192.168.0.130:4533
      - NAVIDROME_USER=root
      - NAVIDROME_PASSWORD=tde7wz79
      
      # 数据库连接
      - POSTGRES_USER=audiomuse
      - POSTGRES_PASSWORD=audiomuse_password
      - POSTGRES_DB=audiomuse
      - POSTGRES_HOST=db
      - REDIS_URL=redis://redis:6379/0
    depends_on:
      - audiomuse-web
    networks:
      - audiomuse-net

networks:
  audiomuse-net:
    driver: bridge
