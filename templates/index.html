{% extends "includes/layout.html" %}

{% block content %}
<div id="main-content-inner">
    <section>
        <div id="config-header">
            <div class="config-title-group">
                <h1>{{ _('AudioMuse-AI - Analysis and Clustering') }}</h1>
                <p class="subtitle">{{ _('Discover new playlists by analyzing your music\'s unique fingerprint.') }}</p>
            </div>
            <div class="header-controls">
                <div class="view-switcher">
                    <button id="basic-view-btn" class="active">{{ _('Basic') }}</button>
                    <button id="advanced-view-btn">{{ _('Advanced') }}</button>
                </div>
            </div>
        </div>

        <form id="config-form">
            <fieldset>
                <legend>{{ _('Analysis Parameters') }}</legend>
                <div class="param-group">
                    <div>
                        <label for="config-num_recent_albums" class="label-with-tooltip">
                            {{ _('Number of Recent Albums:') }}
                            <span class="info-tooltip" tabindex="0">
                                <span class="info-icon"></span>
                                <span class="tooltip-text">{{ _('How many recently added albums to analyze. Set to 0 to analyze your entire music library. Use a smaller number (like 5-10) to quickly test new additions without re-analyzing everything.') }}</span>
                            </span>
                        </label>
                        <input type="number" id="config-num_recent_albums">
                    </div>
                    <div class="advanced-param hidden">
                        <label for="config-top_n_moods" class="label-with-tooltip">
                            {{ _('Top N Moods:') }}
                            <span class="info-tooltip" tabindex="0">
                                <span class="info-icon"></span>
                                <span class="tooltip-text">{{ _('How many dominant moods to identify for each song (e.g., energetic, calm, dark). Higher numbers capture more subtle moods but use more processing power. Default of 5 works well for most libraries.') }}</span>
                            </span>
                        </label>
                        <input type="number" id="config-top_n_moods">
                    </div>
                </div>
            </fieldset>

            <fieldset>
                <legend>{{ _('Clustering Parameters') }}</legend>
                <div class="param-group">
                    <div id="basic-algorithm-display">
                        <label class="label-with-tooltip">
                            {{ _('Clustering Algorithm:') }}
                            <span class="info-tooltip" tabindex="0">
                                <span class="info-icon"></span>
                                <span class="tooltip-text">{{ _('The method used to group similar songs together. K-Means is recommended for most users - it\'s fast and creates balanced playlists. Advanced users can try other algorithms.') }}</span>
                            </span>
                        </label>
                        <p style="font-weight: bold; padding: 0.5rem 0; margin:0;">{{ _('K-Means') }}</p>
                    </div>
                    <div class="advanced-param hidden">
                        <label for="config-cluster_algorithm" class="label-with-tooltip">
                            {{ _('Clustering Algorithm:') }}
                            <span class="info-tooltip" tabindex="0">
                                <span class="info-icon"></span>
                                <span class="tooltip-text">{{ _('K-Means: Balanced groups (recommended). DBSCAN: Finds natural clusters of any shape. GMM: Softer boundaries between groups. Spectral: Good for complex patterns.') }}</span>
                            </span>
                        </label>
                        <select id="config-cluster_algorithm">
                            <option value="kmeans">{{ _('K-Means') }}</option>
                            <option value="dbscan">{{ _('DBSCAN') }}</option>
                            <option value="gmm">{{ _('GMM') }}</option>
                            <option value="spectral">{{ _('Spectral') }}</option>
                        </select>
                    </div>
                    <div>
                        <label for="config-top_n_playlists" class="label-with-tooltip">
                            {{ _('TOP Playlist Number:') }}
                            <span class="info-tooltip" tabindex="0">
                                <span class="info-icon"></span>
                                <span class="tooltip-text">{{ _('How many playlists to create from your library. More playlists means smaller, more focused collections. Try 8-12 for a medium library (1000-5000 songs).') }}</span>
                            </span>
                        </label>
                        <input type="number" id="config-top_n_playlists">
                    </div>
                    <div>
                        <label for="config-clustering_runs" class="label-with-tooltip">
                            {{ _('Clustering Runs:') }}
                            <span class="info-tooltip" tabindex="0">
                                <span class="info-icon"></span>
                                <span class="tooltip-text">{{ _('How many times to try different groupings to find the best playlists. More runs = better results but takes longer. 5000 is a good balance for most libraries.') }}</span>
                            </span>
                        </label>
                        <input type="number" id="config-clustering_runs">
                    </div>
                    <div class="advanced-param hidden">
                        <label for="config-max_distance" class="label-with-tooltip">
                            {{ _('Max Distance:') }}
                            <span class="info-tooltip" tabindex="0">
                                <span class="info-icon"></span>
                                <span class="tooltip-text">{{ _('Maximum sonic difference allowed between songs in the same playlist. Lower values = more similar songs within each playlist. Range: 0.0 (identical) to 1.0 (very different).') }}</span>
                            </span>
                        </label>
                        <input type="number" step="0.01" id="config-max_distance">
                    </div>
                    <div class="advanced-param hidden">
                        <label for="config-max_songs_per_cluster" class="label-with-tooltip">
                            {{ _('Max Songs Per Cluster:') }}
                            <span class="info-tooltip" tabindex="0">
                                <span class="info-icon"></span>
                                <span class="tooltip-text">{{ _('Limit playlist size to this many songs. Set to 0 for no limit. Useful to prevent huge playlists that are hard to listen through.') }}</span>
                            </span>
                        </label>
                        <input type="number" id="config-max_songs_per_cluster">
                    </div>
                    <div class="advanced-param hidden">
                        <label for="config-pca_components_min" class="label-with-tooltip">
                            {{ _('PCA Components Min:') }}
                            <span class="info-tooltip" tabindex="0">
                                <span class="info-icon"></span>
                                <span class="tooltip-text">{{ _('Principal Component Analysis simplifies song data. Minimum number of components to use (0 to disable PCA). Lower = faster but less accurate. Advanced users only.') }}</span>
                            </span>
                        </label>
                        <input type="number" id="config-pca_components_min">
                    </div>
                    <div class="advanced-param hidden">
                        <label for="config-pca_components_max" class="label-with-tooltip">
                            {{ _('PCA Components Max:') }}
                            <span class="info-tooltip" tabindex="0">
                                <span class="info-icon"></span>
                                <span class="tooltip-text">{{ _('Maximum number of PCA components. Higher = more detailed analysis but slower. For embeddings: try 50-199. For feature vectors: try 8-20.') }}</span>
                            </span>
                        </label>
                        <input type="number" id="config-pca_components_max">
                    </div>
                    <div class="advanced-param hidden">
                        <label for="config-min_songs_per_genre_for_stratification" class="label-with-tooltip">
                            {{ _('Min Songs Per Genre for Stratification:') }}
                            <span class="info-tooltip" tabindex="0">
                                <span class="info-icon"></span>
                                <span class="tooltip-text">{{ _('When testing different clustering approaches, sample at least this many songs from each genre. Ensures all music styles are represented. Default: 100.') }}</span>
                            </span>
                        </label>
                        <input type="number" id="config-min_songs_per_genre_for_stratification">
                    </div>
                    <div class="advanced-param hidden">
                        <label for="config-stratified_sampling_target_percentile" class="label-with-tooltip">
                            {{ _('Stratified Sampling Target Percentile:') }}
                            <span class="info-tooltip" tabindex="0">
                                <span class="info-icon"></span>
                                <span class="tooltip-text">{{ _('Percentile used to determine target sample size per genre (0-100). 50 means use median genre size. Higher = more songs sampled. Advanced users only.') }}</span>
                            </span>
                        </label>
                        <input type="number" id="config-stratified_sampling_target_percentile" min="0" max="100">
                    </div>
                    <div class="advanced-param hidden">
                        <label for="config-score_weight_diversity" class="label-with-tooltip">
                            {{ _('Diversity Score Weight:') }}
                            <span class="info-tooltip" tabindex="0">
                                <span class="info-icon"></span>
                                <span class="tooltip-text">{{ _('How much to prioritize different moods BETWEEN playlists. Higher = each playlist has a more unique vibe. Default: 2.0') }}</span>
                            </span>
                        </label>
                        <input type="number" step="0.01" id="config-score_weight_diversity">
                    </div>
                    <div class="advanced-param hidden">
                        <label for="config-score_weight_purity" class="label-with-tooltip">
                            {{ _('Purity Score Weight:') }}
                            <span class="info-tooltip" tabindex="0">
                                <span class="info-icon"></span>
                                <span class="tooltip-text">{{ _('How much to prioritize similar moods WITHIN each playlist. Higher = more consistent vibe within playlists. Default: 1.0') }}</span>
                            </span>
                        </label>
                        <input type="number" step="0.01" id="config-score_weight_purity">
                    </div>
                    <div class="advanced-param hidden">
                        <label for="config-score_weight_other_feature_diversity" class="label-with-tooltip">
                            {{ _('Other Feature Diversity Weight:') }}
                            <span class="info-tooltip" tabindex="0">
                                <span class="info-icon"></span>
                                <span class="tooltip-text">{{ _('Like Diversity Score but for technical audio features (tempo, key, etc.) instead of moods. Usually keep at 0 to focus on moods.') }}</span>
                            </span>
                        </label>
                        <input type="number" step="0.01" id="config-score_weight_other_feature_diversity">
                    </div>
                    <div class="advanced-param hidden">
                        <label for="config-score_weight_other_feature_purity" class="label-with-tooltip">
                            {{ _('Other Feature Purity Weight:') }}
                            <span class="info-tooltip" tabindex="0">
                                <span class="info-icon"></span>
                                <span class="tooltip-text">{{ _('Like Purity Score but for technical audio features instead of moods. Usually keep at 0 to focus on moods.') }}</span>
                            </span>
                        </label>
                        <input type="number" step="0.01" id="config-score_weight_other_feature_purity">
                    </div>
                    <div class="advanced-param hidden">
                        <label for="config-score_weight_silhouette" class="label-with-tooltip">
                            {{ _('Silhouette Score Weight:') }}
                            <span class="info-tooltip" tabindex="0">
                                <span class="info-icon"></span>
                                <span class="tooltip-text">{{ _('Measures how well-separated clusters are. Higher = prioritize clear boundaries between playlists. Usually keep at 0 unless experimenting.') }}</span>
                            </span>
                        </label>
                        <input type="number" step="0.01" id="config-score_weight_silhouette">
                    </div>
                    <div class="advanced-param hidden">
                        <label for="config-score_weight_davies_bouldin" class="label-with-tooltip">
                            {{ _('Davies-Bouldin Score Weight:') }}
                            <span class="info-tooltip" tabindex="0">
                                <span class="info-icon"></span>
                                <span class="tooltip-text">{{ _('Another cluster separation measure. Lower is better (so this score is minimized). Usually keep at 0 unless experimenting.') }}</span>
                            </span>
                        </label>
                        <input type="number" step="0.01" id="config-score_weight_davies_bouldin">
                    </div>
                    <div class="advanced-param hidden">
                        <label for="config-score_weight_calinski_harabasz" class="label-with-tooltip">
                            {{ _('Calinski-Harabasz Score Weight:') }}
                            <span class="info-tooltip" tabindex="0">
                                <span class="info-icon"></span>
                                <span class="tooltip-text">{{ _('Measures cluster quality by comparing within-cluster vs between-cluster variance. Usually keep at 0 unless experimenting.') }}</span>
                            </span>
                        </label>
                        <input type="number" step="0.01" id="config-score_weight_calinski_harabasz">
                    </div>
                    <div class="advanced-param hidden">
                        <label for="config-enable_clustering_embeddings" class="label-with-tooltip">
                            {{ _('Use Embeddings for Clustering:') }}
                            <span class="info-tooltip" tabindex="0">
                                <span class="info-icon"></span>
                                <span class="tooltip-text">{{ _('Checked: Use AI-learned song fingerprints (more accurate). Unchecked: Use calculated features like tempo and energy (faster). Recommended: keep checked.') }}</span>
                            </span>
                        </label>
                        <input type="checkbox" id="config-enable_clustering_embeddings" style="width: auto; margin-left: 5px;">
                    </div>
                </div>

                <!-- K-Means specific parameters (for Basic and Advanced K-Means view) -->
                <div id="kmeans-params-basic" class="hidden"> <!-- Initially hidden; JS controls visibility. Not an 'advanced-param' itself. -->
                    <h4>{{ _('K-Means Specific:') }}</h4>
                    <div class="param-group"> <!-- param-group for styling the inputs -->
                        <div>
                            <label for="config-num_clusters_min" class="label-with-tooltip">
                                {{ _('Min Clusters:') }}
                                <span class="info-tooltip" tabindex="0">
                                    <span class="info-icon"></span>
                                    <span class="tooltip-text">{{ _('Minimum number of playlists K-Means can create. Lower = fewer, larger playlists. Try 40 for a medium library.') }}</span>
                                </span>
                            </label>
                            <input type="number" id="config-num_clusters_min">
                        </div>
                        <div>
                            <label for="config-num_clusters_max" class="label-with-tooltip">
                                {{ _('Max Clusters:') }}
                                <span class="info-tooltip" tabindex="0">
                                    <span class="info-icon"></span>
                                    <span class="tooltip-text">{{ _('Maximum number of playlists K-Means can create. Higher = more, smaller playlists. Try 100 for a medium library.') }}</span>
                                </span>
                            </label>
                            <input type="number" id="config-num_clusters_max">
                        </div>
                    </div>
                </div>

                <div id="dbscan-params" class="advanced-param hidden">
                    <h4>{{ _('DBSCAN Specific:') }}</h4>
                    <div>
                        <label for="config-dbscan_eps_min" class="label-with-tooltip">
                            {{ _('DBSCAN Epsilon Min:') }}
                            <span class="info-tooltip" tabindex="0">
                                <span class="info-icon"></span>
                                <span class="tooltip-text">{{ _('Minimum distance to consider songs as neighbors. Lower = tighter, more exclusive clusters. Advanced users only. Range: 0.1-0.5') }}</span>
                            </span>
                        </label>
                        <input type="number" step="0.01" id="config-dbscan_eps_min">
                    </div>
                    <div>
                        <label for="config-dbscan_eps_max" class="label-with-tooltip">
                            {{ _('DBSCAN Epsilon Max:') }}
                            <span class="info-tooltip" tabindex="0">
                                <span class="info-icon"></span>
                                <span class="tooltip-text">{{ _('Maximum distance to consider songs as neighbors. Higher = looser, more inclusive clusters. Advanced users only. Range: 0.1') }}</span>
-0.5                            </span>
                        </label>
                        <input type="number" step="0.01" id="config-dbscan_eps_max">
                    </div>
                    <div>
                        <label for="config-dbscan_min_samples_min" class="label-with-tooltip">
                            {{ _('DBSCAN Min Samples Min:') }}
                            <span class="info-tooltip" tabindex="0">
                                <span class="info-icon"></span>
                                <span class="tooltip-text">{{ _('Minimum songs needed to form a cluster core. Lower = more small playlists. Advanced users only. Range: 5-20') }}</span>
                            </span>
                        </label>
                        <input type="number" id="config-dbscan_min_samples_min">
                    </div>
                    <div>
                        <label for="config-dbscan_min_samples_max" class="label-with-tooltip">
                            {{ _('DBSCAN Min Samples Max:') }}
                            <span class="info-tooltip" tabindex="0">
                                <span class="info-icon"></span>
                                <span class="tooltip-text">{{ _('Maximum songs needed to form a cluster core. Higher = fewer, larger playlists. Advanced users only. Range: 5-20') }}</span>
                            </span>
                        </label>
                        <input type="number" id="config-dbscan_min_samples_max">
                    </div>
                </div>

                <div id="gmm-params" class="advanced-param hidden">
                    <h4>{{ _('GMM Specific:') }}</h4>
                    <div>
                        <label for="config-gmm_n_components_min" class="label-with-tooltip">
                            {{ _('GMM Components Min:') }}
                            <span class="info-tooltip" tabindex="0">
                                <span class="info-icon"></span>
                                <span class="tooltip-text">{{ _('Minimum number of Gaussian components (similar to clusters). GMM allows songs to belong partially to multiple playlists. Advanced users only.') }}</span>
                            </span>
                        </label>
                        <input type="number" id="config-gmm_n_components_min">
                    </div>
                    <div>
                        <label for="config-gmm_n_components_max" class="label-with-tooltip">
                            {{ _('GMM Components Max:') }}
                            <span class="info-tooltip" tabindex="0">
                                <span class="info-icon"></span>
                                <span class="tooltip-text">{{ _('Maximum number of Gaussian components. Higher = more nuanced groupings but slower computation. Advanced users only.') }}</span>
                            </span>
                        </label>
                        <input type="number" id="config-gmm_n_components_max">
                    </div>
                </div>

                <div id="spectral-params" class="advanced-param hidden">
                    <h4>{{ _('Spectral Specific:') }}</h4>
                    <div>
                        <label for="config-spectral_n_clusters_min" class="label-with-tooltip">
                            {{ _('Spectral Clusters Min:') }}
                            <span class="info-tooltip" tabindex="0">
                                <span class="info-icon"></span>
                                <span class="tooltip-text">{{ _('Minimum number of clusters for Spectral clustering. Spectral is good at finding complex patterns and non-spherical groups. Advanced users only.') }}</span>
                            </span>
                        </label>
                        <input type="number" id="config-spectral_n_clusters_min">
                    </div>
                    <div>
                        <label for="config-spectral_n_clusters_max" class="label-with-tooltip">
                            {{ _('Spectral Clusters Max:') }}
                            <span class="info-tooltip" tabindex="0">
                                <span class="info-icon"></span>
                                <span class="tooltip-text">{{ _('Maximum number of clusters for Spectral clustering. Higher = more playlists but much slower. Advanced users only.') }}</span>
                            </span>
                        </label>
                        <input type="number" id="config-spectral_n_clusters_max">
                    </div>
                </div>
            </fieldset>

            <fieldset>
                <legend>{{ _('AI Playlist Naming') }}</legend>
                <div class="param-group">
                    <div>
                        <label for="config-ai_model_provider" class="label-with-tooltip">
                            {{ _('AI Provider:') }}
                            <span class="info-tooltip" tabindex="0">
                                <span class="info-icon"></span>
                                <span class="tooltip-text">{{ _('OPTIONAL: Choose an AI service to generate creative playlist names for your clustering results. This is just for naming - it doesn\'t affect how playlists are created. Select "None" if you prefer default names or don\'t want to use AI.') }}</span>
                            </span>
                        </label>
                        <select id="config-ai_model_provider">
                            <option value="OLLAMA">{{ _('Ollama') }}</option>
                            <option value="OPENAI">{{ _('OpenAI / OpenRouter') }}</option>
                            <option value="GEMINI">{{ _('Gemini') }}</option>
                            <option value="MISTRAL">{{ _('Mistral') }}</option>
                            <option value="DEEPSEEK">{{ _('DeepSeek') }}</option>
                            <option value="NONE" selected>{{ _('None') }}</option>
                        </select>
                    </div>

                    <div id="ollama-config-group" class="hidden">
                        <h4>{{ _('Ollama Configuration:') }}</h4>
                        <div>
                            <label for="config-ollama_server_url">{{ _('Ollama Server URL:') }}</label>
                            <input type="text" id="config-ollama_server_url" value="http://127.0.0.1:11434/api/generate">
                        </div>
                        <div>
                            <label for="config-ollama_model_name">{{ _('Ollama Model Name:') }}</label>
                            <input type="text" id="config-ollama_model_name" value="mistral:7b">
                        </div>
                    </div>

                    <div id="openai-config-group" class="hidden">
                        <h4>{{ _('OpenAI / OpenRouter Configuration:') }}</h4>
                        <div>
                            <label for="config-openai_server_url">{{ _('OpenAI Server URL:') }}</label>
                            <input type="text" id="config-openai_server_url" value="https://openrouter.ai/api/v1/chat/completions">
                        </div>
                        <div>
                            <label for="config-openai_model_name">{{ _('OpenAI Model Name:') }}</label>
                            <input type="text" id="config-openai_model_name" value="">
                        </div>
                    </div>

                    <div id="gemini-config-group" class="hidden">
                        <h4>{{ _('Gemini Configuration:') }}</h4>
                        <div>
                            <label for="config-gemini_model_name">{{ _('Gemini Model Name:') }}</label>
                            <input type="text" id="config-gemini_model_name" value="gemini-2.5-pro">
                        </div>
                    </div>

                    <div id="mistral-config-group" class="hidden">
                        <h4>{{ _('Mistral Configuration:') }}</h4>
                        <div>
                            <label for="config-mistral_model_name">{{ _('Mistral Model Name:') }}</label>
                            <input type="text" id="config-mistral_model_name" value="ministral-3b-latest">
                        </div>
                    </div>

                    <div id="deepseek-config-group" class="hidden">
                        <h4>{{ _('DeepSeek Configuration:') }}</h4>
                        <div>
                            <label for="config-deepseek_server_url">{{ _('DeepSeek Server URL:') }}</label>
                            <input type="text" id="config-deepseek_server_url" value="https://api.deepseek.com/v1">
                        </div>
                        <div>
                            <label for="config-deepseek_model_name">{{ _('DeepSeek Model Name:') }}</label>
                            <input type="text" id="config-deepseek_model_name" value="deepseek-chat">
                        </div>
                    </div>
                </div>
            </fieldset>
        </form>
    </section>

    <section>
        <h2>{{ _('Run Tasks') }}</h2>
        <div class="task-buttons">
            <button id="start-analysis-btn">{{ _('Start Analysis') }}</button>
            <button id="start-clustering-btn">{{ _('Start Clustering') }}</button>
            <button id="fetch-playlists-btn">{{ _('Fetch Playlists') }}</button>
        </div>
        <button id="cancel-task-btn">{{ _('Cancel Current Task') }}</button>
    </section>

    <section>
        <h2>{{ _('Task Status') }}</h2>
        <div id="task-status-display">
            <p><span class="status-label">{{ _('Task ID:') }}</span> <span id="status-task-id">{{ _('N/A') }}</span></p>
            <p><span class="status-label">{{ _('Running Time:') }}</span> <span id="status-running-time">-- : -- : --</span></p>
            <p><span class="status-label">{{ _('Type:') }}</span> <span id="status-task-type">{{ _('N/A') }}</span></p>
            <p><span class="status-label">{{ _('Status:') }}</span> <span id="status-status">{{ _('IDLE') }}</span></p>
            <p><span class="status-label">{{ _('Status Message:') }}</span> <span id="status-log">{{ _('N/A') }}</span></p>
            <p><span class="status-label">{{ _('Progress:') }}</span> <span id="status-progress">0</span>%</p>
            <div class="progress-bar-container">
                <div id="progress-bar"></div>
            </div>
            <div style="margin-top: 1rem;">
                <h3>{{ _('Details / Log:') }}</h3>
                <pre id="status-details"></pre>
            </div>
        </div>
    </section>

    <section id="playlists-section">
        <h2>{{ _('Generated Playlists') }}</h2>
        <div id="playlists-container"></div>
    </section>
</div>
{% endblock %}

{% block bodyAdditions %}
    <script src="{{ url_for('static', filename='menu.js') }}"></script>
    {% include 'script.html' %}
{% endblock %}
